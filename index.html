<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step by Step Academy - Aula Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f7f9fc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 18px 36px rgba(0, 0, 0, 0.12), 0 14px 24px rgba(0, 0, 0, 0.08);
            padding: 2.5rem;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            transition: all 0.3s ease-in-out;
        }
        @media (min-width: 768px) {
            .container {
                padding: 3rem;
            }
        }
        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
        }
        .option-button {
            display: block;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            text-align: left;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .option-button:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .option-button.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .multiple-select-option:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .multiple-select-option.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.5);
            accent-color: #6366f1;
        }
        .main-button, .send-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .main-button {
            background-image: linear-gradient(to right, #6366f1, #4338ca);
            color: white;
        }
        .main-button:hover {
            background-image: linear-gradient(to right, #4338ca, #312e81);
            transform: translateY(-4px);
        }
        .main-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled, .send-button:disabled {
            background-image: linear-gradient(to right, #cbd5e1, #94a3b8);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .send-button {
             background-image: linear-gradient(to right, #10b981, #059669);
             color: white;
        }
        .send-button:hover {
            background-image: linear-gradient(to right, #059669, #047857);
            transform: translateY(-4px);
        }
        .send-button:active {
            transform: translateY(0);
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #6366f1;
            width: 0%;
            border-radius: 9999px;
            transition: width 0.3s ease-out;
        }
        .direct-answer-input {
            width: 100%;
            padding: 1.1rem 1.5rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            color: #3f4a5a;
        }
        .direct-answer-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #final-thanks-message {
            text-align: center;
            font-size: 2.8rem;
            font-weight: 800;
            color: #4338ca;
            margin-top: 60px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease-out, transform 1s ease-out;
            line-height: 1.3;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #ffffff;
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        #final-thanks-message.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3f4a5a;
            background-color: #e6f2ff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            margin-left: auto;
            min-width: 120px;
            text-align: center;
        }
        .timer-display.low-time {
            color: #dc2626;
            background-color: #fee2e2;
        }
        .multi-part-question-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .multi-part-question-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .multi-part-question-item label {
            font-weight: 600;
            color: #4a5568;
        }
        .module-selection-card {
            background-color: #f0f4f8;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .module-selection-card select {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border-radius: 0.75rem;
            border: 2px solid #e0e7ee;
            background-color: #ffffff;
            color: #3f4a5a;
        }
        .module-selection-card select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .attempts-counter {
            font-weight: 600;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="quiz-app" class="container">
        <div id="main-header" class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-2">Step by Step Academy</h1>
            <p class="text-lg text-gray-600 italic">"Tu camino al éxito en inglés, paso a paso."</p>
        </div>

        <div id="login-screen" class="text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">¡Hola de nuevo!</h2>
            <h3 class="text-xl font-bold text-gray-600 mb-4">Ingresa tus datos para continuar</h3>
            
            <div class="mb-4 space-y-3">
                <input type="text" id="user-name" placeholder="Tu Nombre" class="direct-answer-input" required>
                <input type="text" id="user-surname" placeholder="Tu Apellido" class="direct-answer-input" required>
                <input type="email" id="user-email" placeholder="Tu Correo Electrónico" class="direct-answer-input" required>
                <input type="text" id="user-id-card" placeholder="Tu Cédula de Identidad" class="direct-answer-input" required>
            </div>
            
            <div class="flex justify-center mt-6">
                <button id="start-app-button" class="main-button" disabled>Iniciar</button>
            </div>
        </div>

        <div id="main-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">¡Bienvenido al Aula Virtual!</h2>
            <p class="text-lg text-gray-600 italic mb-6">Selecciona un módulo para comenzar tu práctica</p>
            
            <div class="module-selection-card">
                <label for="module-select" class="text-left text-xl font-semibold text-gray-800">1. Selecciona un Módulo:</label>
                <select id="module-select" class="w-full">
                    <option value="" disabled selected>-- Elige un tema --</option>
                    <option value="module1">Módulo 1: Inglés Básico</option>
                </select>
            </div>
            
            <div id="module-info" class="hidden text-left mt-4 p-4 bg-gray-100 rounded-lg">
                <h3 class="font-bold text-lg text-gray-800 mb-2">Descripción:</h3>
                <p id="module-description" class="text-gray-700"></p>
                <p class="font-bold text-blue-700 mt-4"><i class="fas fa-hourglass-half text-blue-600 mr-2"></i> Duración estimada: <span id="module-duration"></span></p>
                <p id="attempts-display" class="font-bold text-blue-700 attempts-counter mt-4"><i class="fas fa-redo-alt text-blue-600 mr-2"></i> Intentos restantes: <span id="remaining-attempts"></span></p>
            </div>

            <div class="flex justify-center mt-6">
                <button id="start-module-button" class="main-button" disabled>Comenzar</button>
            </div>
        </div>

        <div id="instructions-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Instrucciones de la Prueba</h2>
            <div class="text-left text-gray-700 text-lg space-y-4 mb-8">
                <p class="font-bold text-blue-700"><i class="fas fa-exclamation-triangle text-red-600 mr-2"></i> **Important:** You have **only one opportunity** to complete this test. / **Importante:** Solo tienes **una única oportunidad** para completar esta prueba.</p>
                <p class="font-bold text-blue-700"><i class="fas fa-star text-blue-600 mr-2"></i> Each correct answer is worth 0.4 points. Maximum score: 20 points. / Cada respuesta correcta vale 0.4 puntos. Puntuación máxima: 20 puntos.</p>
                <p><i class="fas fa-book-reader text-blue-600 mr-2"></i> Read each item carefully before answering. / Lee cada ítem cuidadosamente antes de responder.</p>
                <p><i class="fas fa-check-square text-blue-600 mr-2"></i> For **multiple-choice** items, you can choose one or more options. Each correct option adds points. / Para los ítems de **selección múltiple**, puedes elegir una o varias opciones. Cada opción correcta suma puntos.</p>
                <p><i class="fas fa-keyboard text-blue-600 mr-2"></i> For **direct answer** items, write your answer in the provided field. Be careful with spelling and grammar. / Para los ítems de **respuesta directa**, escribe tu respuesta en el campo provisto. Asegúrate de la ortografía y gramática.</p>
                <p><i class="fas fa-arrows-alt-h text-blue-600 mr-2"></i> You can navigate between items using the 'Back' and 'Next' buttons. / Puedes navegar entre los ítems usando los botones 'Atrás' y 'Siguiente'.</p>
                <p class="font-bold text-blue-700"><i class="fas fa-check-circle text-green-600 mr-2"></i> **Review your answers carefully** before clicking "Finish Test". / **Revisa cuidadosamente tus respuestas** antes de hacer clic en "Finalizar Prueba".</p>
                <p class="font-bold text-blue-700"><i class="fas fa-hourglass-half text-blue-600 mr-2"></i> The time limit is 120 minutes. Good luck! / El tiempo límite es de 120 minutos. ¡Mucha suerte!</p>
            </div>
            <button id="start-first-question-button" class="main-button">Entendido, ¡Comenzar!</button>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="question-counter" class="text-gray-600 font-medium text-lg"></span>
                <div id="timer-display" class="timer-display">00:00</div>
            </div>
            <div class="progress-bar-container mb-6"><div id="progress-bar" class="progress-bar"></div></div>
            <h2 id="question-text" class="text-2xl font-semibold text-gray-800 mb-6"></h2>
            <div id="options-container" class="flex flex-col gap-3"></div>
            <div class="flex justify-between gap-4 mt-8">
                <button id="prev-button" class="main-button w-1/2" disabled>Atrás</button>
                <button id="next-button" class="main-button w-1/2" disabled>Siguiente</button>
            </div>
        </div>

        <div id="results-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">¡Prueba Finalizada!</h2>
            
            <button id="send-delia-email-button" class="send-button mt-8 w-full">
                <i class="fas fa-save"></i> Guardar Resultados
            </button>
            <div id="email-status-message" class="text-sm mt-2 text-gray-600 hidden"></div>
        </div>
    </div>

    <div id="final-thanks-message" class="hidden">
        ¡Gracias por completar la prueba!
    </div>

    <script>
        // EmailJS initialization
        (function() {
            emailjs.init("7FE4lqcCZ69cThSp_"); 
        })();

        // --- URLs DE GOOGLE APPS SCRIPT ---
        const loginAppScriptUrl = 'https://script.google.com/macros/s/AKfycbzL5E-f20389v6C09o2l22X25-rXfS-kH6o0s/exec'; // URL del script de login
        const attemptsCheckerUrl = 'https://script.google.com/macros/s/AKfycbzL5E-f20389v6C09o2l22X25-rXfS-kH6o0s/exec'; // ¡Es la misma URL del script de login!
        const resultsAppScriptUrl = 'https://script.google.com/macros/s/AKfycbzL5E-f20389v6C09o2l22X25-rXfS-kH6o0s/exec'; // ¡Es la misma URL del script de login!

        // --- QUIZ DATA ---
        const modules = {
            'module1': {
                name: 'Módulo 1: Inglés Básico',
                attemptsColumn: 'Módulo 1 - Intentos',
                description: 'En este módulo aprenderás las bases del inglés, incluyendo saludos, números, días de la semana y el verbo "To be". / In this module you will learn the basics of English, including greetings, numbers, days of the week, and the verb "To be".',
                duration: '120 minutos',
                questions: [
                    {
                        question: "Presentación y saludos (formal/informal)<br>Which of the following are informal greetings? (Select all that apply) / ¿Cuáles de las siguientes son saludos informales? (Selecciona todas las que apliquen):",
                        type: "multiple-select",
                        options: [
                            { text: "a) Hi", value: "a", isCorrect: true },
                            { text: "b) Good evening", value: "b", isCorrect: false },
                            { text: "c) Morning", value: "c", isCorrect: true },
                            { text: "d) Hello", value: "d", isCorrect: false },
                            { text: "e) How’s everything?", value: "e", isCorrect: true },
                            { text: "f) Good morning", value: "f", isCorrect: false },
                            { text: "g) How’s it going?", value: "g", isCorrect: true }
                        ],
                        topic: "Presentación y saludos (formal/informal)",
                        scoreParts: 4
                    },
                    {
                        question: "Despedidas<br>Select the appropriate ways to say goodbye. / Selecciona las formas en que podemos despedirnos (Escoge todas las que apliquen):",
                        type: "multiple-select",
                        options: [
                            { text: "a) Bye", value: "a", isCorrect: true },
                            { text: "b) See you later", value: "b", isCorrect: true },
                            { text: "c) Good night", value: "c", isCorrect: true },
                            { text: "d) Hello", value: "d", isCorrect: false },
                            { text: "e) What’s up?", value: "e", isCorrect: false },
                            { text: "f) How do you do?", value: "f", isCorrect: false },
                            { text: "g) Good morning", value: "g", isCorrect: false }
                        ],
                        topic: "Despedidas",
                        scoreParts: 4
                    },
                    {
                        question: "Días de la semana<br>Select the correct order. / Selecciona el orden correcto:",
                        type: "single-choice",
                        options: [
                            "a) Wednesday, Monday, Tuesday, Thursday, Friday, Saturday, Sunday",
                            "b) Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday",
                            "c) Monday, Thursday, Wednesday, Tuesday, Friday, Saturday, Sunday",
                            "d) Monday, Tuesday, Wednesday, Thursday, Friday, Sunday, Saturday"
                        ],
                        answer: "b) Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday",
                        topic: "Días de la semana",
                        scoreParts: 1
                    },
                    {
                        question: "Meses del año<br>Which of these are months of the year? (Select all that apply) / ¿Cuáles de estos son meses del año? (Selecciona todas las que apliquen):",
                        type: "multiple-select",
                        options: [
                            { text: "a) January", value: "a", isCorrect: true },
                            { text: "b) Morning", value: "b", isCorrect: false },
                            { text: "c) Saturday", value: "c", isCorrect: false },
                            { text: "d) April", value: "d", isCorrect: true },
                            { text: "e) Friday", value: "e", isCorrect: false },
                            { text: "f) December", value: "f", isCorrect: true },
                            { text: "g) August", value: "g", isCorrect: true }
                        ],
                        topic: "Meses del año",
                        scoreParts: 4
                    },
                    {
                        question: "Números cardinales y ordinales<br>Choose the correct ordinal numbers. / Escoge los números ordinales:",
                        type: "multiple-select",
                        options: [
                            { text: "a) First", value: "a", isCorrect: true },
                            { text: "b) Three", value: "b", isCorrect: false },
                            { text: "c) Second", value: "c", isCorrect: true },
                            { text: "d) Twelve", "value": "d", isCorrect: false },
                            { text: "e) Third", value: "e", isCorrect: true },
                            { text: "f) Fifth", value: "f", isCorrect: true },
                            { text: "g) Eighteen", value: "g", isCorrect: false }
                        ],
                        topic: "Números cardinales y ordinales",
                        scoreParts: 4
                    },
                    {
                        question: "Verbo “To be” (presente)<br>Choose the correct positive sentence with the verb “to be”. / Selecciona las oraciones positivas que estén escritas correctamente:",
                        type: "multiple-select",
                        options: [
                            { text: "a) I is happy", value: "a", isCorrect: false },
                            { text: "b) She are tired", value: "b", isCorrect: false },
                            { text: "c) They are friends", value: "c", isCorrect: true },
                            { text: "d) You am busy", value: "d", isCorrect: false },
                            { text: "e) We are teachers", value: "e", isCorrect: true },
                            { text: "f) He are my brother", value: "f", isCorrect: false },
                            { text: "g) It is cold", value: "g", isCorrect: true }
                        ],
                        topic: "Verbo “To be” (presente)",
                        scoreParts: 3
                    },
                    {
                        question: "Oraciones negativas con “To be”<br>Complete the sentences with the correct negative form. / Completa las oraciones negativas con la forma correcta:",
                        type: "multi-direct-answer",
                        parts: [
                            { prompt: "1. I _______ a student.", answer: ["am not", "'m not"] }, 
                            { prompt: "2. They _____ at home.", answer: ["are not", "aren't"] }, 
                            { prompt: "3. He ______ a doctor.", answer: ["is not", "isn't"] },   
                            { prompt: "4. She _____ happy.", answer: ["is not", "isn't"] },
                            { prompt: "5. We ____ ready.", answer: ["are not", "aren't"] },
                            { prompt: "6. It ______ sunny.", answer: ["is not", "isn't"] },
                            { prompt: "7. You _______ tired.", answer: ["are not", "aren't"] } 
                        ],
                        topic: "Oraciones negativas con “To be”",
                        scoreParts: 7
                    },
                    {
                        question: "Interrogativas con “To be”<br>Transform the following positive sentences into interrogative sentences. / Transforma las siguientes oraciones positivas a oraciones interrogativas:",
                        type: "multi-direct-answer",
                        parts: [
                            { prompt: "a) You are okay", answer: ["Are you okay?"] }, 
                            { prompt: "b) They are hungry", answer: ["Are they hungry?"] },
                            { prompt: "c) He is a teacher", answer: ["Is he a teacher?"] },
                            { prompt: "d) We are ready", answer: ["Are we ready?"] },
                            { prompt: "e) She is at school", answer: ["Is she at school?"] },
                            { prompt: "f) They are friends", answer: ["Are they friends?"] }
                        ],
                        topic: "Interrogativas con “To be”",
                        scoreParts: 6
                    },
                    {
                        question: "A vs. An<br>Write the correct article for each noun. / Escribe el artículo correcto para cada sustantivo (Opción correcta: a/an según el caso):",
                        type: "multi-direct-answer",
                        parts: [
                            { prompt: "a) __ apple", answer: ["an"] },
                            { prompt: "b) __ orange", answer: ["an"] },
                            { prompt: "c) __ book", answer: ["a"] },
                            { prompt: "d) __ umbrella", answer: ["an"] },
                            { prompt: "e) __ elephant", answer: ["an"] }, 
                            { prompt: "f) __ pen", answer: ["a"] },
                            { prompt: "g) __ hour", answer: ["an"] }
                        ],
                        topic: "A vs. An",
                        scoreParts: 7
                    },
                    {
                        question: "Nouns y plural nouns<br>Choose the correct plural form. / Escoge el sustantivo plural correcto:",
                        type: "multiple-select",
                        options: [
                            { text: "a) Baby → Babys", value: "a", isCorrect: false },
                            { text: "b) Child → Childs", value: "b", isCorrect: false },
                            { text: "c) Man → Men", value: "c", isCorrect: true },
                            { text: "d) Woman → Women", value: "d", isCorrect: true },
                            { text: "e) Mouse → Mouses", value: "e", isCorrect: false },
                            { text: "f) Tooth → Teeth", value: "f", isCorrect: true },
                            { text: "g) Foot → Feet", value: "g", isCorrect: true }
                        ],
                        topic: "Nouns y plural nouns",
                        scoreParts: 4
                    },
                    {
                        question: "Partes del cuerpo<br>Translate the following body parts into Spanish. / Traduce las siguientes partes del cuerpo al español:",
                        type: "multi-direct-answer",
                        parts: [
                            { prompt: "1. Hand", answer: ["mano"] },
                            { prompt: "2. Foot", answer: ["pie"] },
                            { prompt: "3. Head", answer: ["cabeza"] }
                        ],
                        topic: "Partes del cuerpo",
                        scoreParts: 3
                    },
                    {
                        question: "Familia (integrantes)<br>Translate the following family members into Spanish. / Traduce los siguientes miembros de la familia al español:",
                        type: "multi-direct-answer",
                        parts: [
                            { prompt: "1. Mother", answer: ["madre"] },
                            { prompt: "2. Father", answer: ["padre"] },
                            { prompt: "3. Sister", answer: ["hermana"] }
                        ],
                        topic: "Familia (integrantes)",
                        scoreParts: 3
                    }
                ]
            }
        };

        // --- GLOBAL QUIZ VARIABLES ---
        let selectedModuleId = null;
        let quizQuestions = [];
        let shuffledQuestions = [];
        let currentQuestionIndex = 0;
        let rawScore = 0; 
        let userAnswers = [];
        let incorrectQuestionsData = [];
        let correctQuestionsData = [];
        let userName = '', userSurname = '', userEmail = '', userIdCard = ''; 
        let timerInterval; 
        const QUIZ_DURATION_MINUTES = 25;
        let remainingTime; 
        let quizSubmittedByTimeOut = false; 
        let quizStartTime;
        let isQuizCompleted = false;

        // --- DOM ELEMENTS ---
        let quizAppContainer;
        let mainHeader;
        let loginScreen;
        let mainScreen;
        let instructionsScreen; 
        let quizScreen;
        let resultsScreen;
        let startAppButton;
        let startModuleButton;
        let startFirstQuestionButton; 
        let userNameInput;
        let userSurnameInput;
        let userEmailInput;
        let userIdCardInput;
        let moduleSelect;
        let moduleInfo;
        let moduleDescription;
        let moduleDuration;
        let attemptsDisplay;
        let remainingAttemptsSpan;
        let questionCounter;
        let progressBar;
        let questionText;
        let optionsContainer;
        let nextButton;
        let prevButton; 
        let sendEmailButton; 
        let statusMessage; 
        let finalThanksMessage;
        let timerDisplay; 
        let currentQuizData;

        // --- CONSTANTS ---
        const MAX_RAW_SCORE = 50; 
        const FINAL_MAX_SCORE = 20; 
        const QUIZ_COMPLETED_PREFIX = 'stepByStepQuizCompleted_'; 
        const QUIZ_DATA_STORAGE_KEY = 'stepByStepQuizData'; 
        const authorizedIdNumbers = [
            '3717064',
            '21291785',
            '19399996',
            '10793197',
            '18603986',
            '7585443',
            '7920622',
            '10182240',
            '31725050',
            '33619493'
        ];
        const UNLIMITED_ACCESS_ID = '3717064';
        const MAX_ATTEMPTS = 3;
        
        function displayMessageBox(title, message) {
            alert(`${title}\n\n${message}`);
        }

        function showScreen(screenId) {
            loginScreen.classList.add('hidden');
            mainScreen.classList.add('hidden');
            instructionsScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            finalThanksMessage.classList.add('hidden');

            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                quizAppContainer.classList.remove('hidden');
            } else {
                console.error(`Error: Screen with ID '${screenId}' not found.`);
                quizAppContainer.classList.add('hidden');
            }

            if (screenId === 'quiz-screen' || screenId === 'instructions-screen') {
                mainHeader.classList.add('hidden');
            } else {
                mainHeader.classList.remove('hidden');
            }

            if (screenId === 'login-screen') {
                userNameInput.value = '';
                userSurnameInput.value = '';
                userEmailInput.value = '';
                userIdCardInput.value = '';
                checkLoginInputsAndEnableButton();
            } else if (screenId === 'main-screen') {
                moduleSelect.value = '';
                moduleInfo.classList.add('hidden');
                startModuleButton.disabled = true;
            }
        }
        
        // --- LOGIN & ATTEMPTS LOGIC ---
        function checkLoginInputsAndEnableButton() {
            const isNameValid = userNameInput.value.trim() !== '';
            const isSurnameValid = userSurnameInput.value.trim() !== '';
            const isEmailValid = userEmailInput.value.trim() !== '' && userEmailInput.checkValidity();
            const isIdCardValid = authorizedIdNumbers.includes(userIdCardInput.value.trim()) || userIdCardInput.value.trim() === UNLIMITED_ACCESS_ID;
            startAppButton.disabled = !(isNameValid && isSurnameValid && isEmailValid && isIdCardValid);
        }

        async function startApp() {
            userName = userNameInput.value.trim();
            userSurname = userSurnameInput.value.trim();
            userEmail = userEmailInput.value.trim();
            userIdCard = userIdCardInput.value.trim();

            const isIdCardRegistered = authorizedIdNumbers.includes(userIdCard);
            const isUnlimitedAccess = userIdCard === UNLIMITED_ACCESS_ID;

            if (!isIdCardRegistered && !isUnlimitedAccess) {
                displayMessageBox("Error de Acceso", "Tu cédula no está autorizada para acceder a la plataforma. Por favor, contacta a la administración.");
                return;
            }

            showScreen('main-screen');
        }

        async function loadModule() {
            selectedModuleId = moduleSelect.value;
            if (selectedModuleId) {
                currentQuizData = modules[selectedModuleId];
                moduleDescription.innerHTML = currentQuizData.description;
                moduleDuration.textContent = QUIZ_DURATION_MINUTES + ' minutos';
                moduleInfo.classList.remove('hidden');

                const attempts = await getStudentAttempts();
                const remaining = MAX_ATTEMPTS - attempts;
                remainingAttemptsSpan.textContent = remaining > 0 ? remaining : 0;
                
                if (remaining > 0 || userIdCard === UNLIMITED_ACCESS_ID) {
                    startModuleButton.disabled = false;
                } else {
                    startModuleButton.disabled = true;
                    displayMessageBox("Intentos Agotados", "Has agotado tus 3 intentos para este módulo.");
                }

            } else {
                moduleInfo.classList.add('hidden');
                startModuleButton.disabled = true;
            }
        }

        async function getStudentAttempts() {
            const moduleAttemptsColumn = currentQuizData.attemptsColumn;

            const requestBody = {
                action: "getAttempts",
                email: userEmail,
                idCard: userIdCard,
                attemptsColumn: moduleAttemptsColumn
            };

            try {
                const response = await fetch(attemptsCheckerUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    redirect: 'follow',
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (data.success) {
                    return data.attempts;
                } else {
                    console.error("Error al obtener intentos:", data.message);
                    return 0;
                }
            } catch (error) {
                console.error("Error al comunicarse con Apps Script:", error);
                return 0;
            }
        }

        // --- TIMER LOGIC ---
        function startTimer() {
            quizStartTime = new Date();
            remainingTime = QUIZ_DURATION_MINUTES * 60;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    autoSubmitQuiz();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerDisplay.textContent = formattedTime;
            if (remainingTime <= 60) {
                timerDisplay.classList.add('low-time');
            } else {
                timerDisplay.classList.remove('low-time');
            }
        }

        function autoSubmitQuiz() {
            quizSubmittedByTimeOut = true;
            optionsContainer.querySelectorAll('button, input').forEach(element => element.disabled = true);
            nextButton.disabled = true;
            prevButton.disabled = true;
            displayMessageBox("¡Tiempo Agotado!", "El tiempo para completar la prueba ha terminado. Tus respuestas se enviarán automáticamente.");
            submitQuiz();
        }

        // --- QUIZ LOGIC ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function interleaveQuestions(questions) {
            const selectionQuestions = questions.filter(q => q.type === "single-choice" || q.type === "multiple-select");
            const writingQuestions = questions.filter(q => q.type === "direct-answer" || q.type === "multi-direct-answer");
            shuffleArray(selectionQuestions);
            shuffleArray(writingQuestions);
            const interleaved = [];
            let sIdx = 0;
            let wIdx = 0;
            while (sIdx < selectionQuestions.length || wIdx < writingQuestions.length) {
                if (sIdx < selectionQuestions.length) {
                    interleaved.push(selectionQuestions[sIdx]);
                    sIdx++;
                }
                if (wIdx < writingQuestions.length) {
                    interleaved.push(writingQuestions[wIdx]);
                    wIdx++;
                }
            }
            return interleaved;
        }

        function isAnswerCorrect(userAnswer, correctAnswer) {
            const normalizedUserAnswer = (userAnswer || '').toLowerCase().trim();
            if (Array.isArray(correctAnswer)) {
                const normalizedCorrectAnswers = correctAnswer.map(a => a.toLowerCase().trim());
                const isCorrect = normalizedCorrectAnswers.includes(normalizedUserAnswer);
                return isCorrect;
            } else {
                const normalizedCorrectAnswer = correctAnswer.toLowerCase().trim();
                const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
                return isCorrect;
            }
        }

        function startModule() {
            quizQuestions = currentQuizData.questions;
            shuffledQuestions = interleaveQuestions(quizQuestions);
            currentQuestionIndex = 0;
            userAnswers = Array(shuffledQuestions.length).fill(null);
            rawScore = 0;
            
            showScreen('instructions-screen');
        }

        function renderQuestion() {
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            questionCounter.textContent = `Ítem ${currentQuestionIndex + 1} de ${shuffledQuestions.length}`;
            progressBar.style.width = `${((currentQuestionIndex + 1) / shuffledQuestions.length) * 100}%`;
            questionText.innerHTML = currentQuestion.question;
            optionsContainer.innerHTML = '';
            
            saveCurrentAnswer();

            if (currentQuestion.type === "single-choice" || currentQuestion.type === "multiple-select") {
                const previouslySelected = userAnswers[currentQuestionIndex];

                if (currentQuestion.type === "single-choice") {
                    currentQuestion.options.forEach((option, index) => {
                        const button = document.createElement('button');
                        button.classList.add('option-button');
                        button.textContent = option;
                        if (previouslySelected === option) {
                            button.classList.add('selected');
                        }
                        button.addEventListener('click', () => {
                            const selectedOptionElement = optionsContainer.querySelector('.option-button.selected');
                            if (selectedOptionElement) {
                                selectedOptionElement.classList.remove('selected');
                            }
                            button.classList.add('selected');
                            userAnswers[currentQuestionIndex] = option;
                            updateNavigationButtons();
                        });
                        optionsContainer.appendChild(button);
                    });
                } else if (currentQuestion.type === "multiple-select") {
                    currentQuestion.options.forEach((option) => {
                        const label = document.createElement('label');
                        label.classList.add('multiple-select-option');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = option.value;
                        checkbox.addEventListener('change', () => {
                            label.classList.toggle('selected', checkbox.checked);
                            updateNavigationButtons();
                        });

                        const textSpan = document.createElement('span');
                        textSpan.textContent = option.text;

                        label.appendChild(checkbox);
                        label.appendChild(textSpan);

                        if (previouslySelected && previouslySelected.includes(option.value)) {
                            checkbox.checked = true;
                            label.classList.add('selected');
                        }

                        label.addEventListener('click', (event) => {
                            if (event.target !== checkbox) {
                                checkbox.checked = !checkbox.checked;
                                label.classList.toggle('selected', checkbox.checked);
                                updateNavigationButtons();
                            }
                        });

                        optionsContainer.appendChild(label);
                    });
                }
            } else if (currentQuestion.type === "multi-direct-answer") {
                const previouslyEntered = userAnswers[currentQuestionIndex] || {};
                const multiPartContainer = document.createElement('div');
                multiPartContainer.classList.add('multi-part-question-container');

                currentQuestion.parts.forEach((part, index) => {
                    const partContainer = document.createElement('div');
                    partContainer.classList.add('multi-part-question-item');
                    
                    const label = document.createElement('label');
                    label.textContent = part.prompt;
                    partContainer.appendChild(label);

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.classList.add('direct-answer-input');
                    input.value = previouslyEntered[index] || '';
                    input.addEventListener('input', updateNavigationButtons);
                    partContainer.appendChild(input);
                    multiPartContainer.appendChild(partContainer);
                });
                
                optionsContainer.appendChild(multiPartContainer);
            }
            
            updateNavigationButtons();
        }

        function saveCurrentAnswer() {
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            if (currentQuestion) {
                if (currentQuestion.type === "single-choice") {
                    const selectedOptionElement = optionsContainer.querySelector('.option-button.selected');
                    userAnswers[currentQuestionIndex] = selectedOptionElement ? selectedOptionElement.textContent : null;
                } else if (currentQuestion.type === "multiple-select") {
                    const selectedOptions = Array.from(optionsContainer.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                    userAnswers[currentQuestionIndex] = selectedOptions;
                } else if (currentQuestion.type === "multi-direct-answer") {
                    const answers = {};
                    optionsContainer.querySelectorAll('.multi-part-question-item input').forEach((input, index) => {
                        answers[index] = input.value.trim();
                    });
                    userAnswers[currentQuestionIndex] = answers;
                }
            }
        }

        function updateNavigationButtons() {
            prevButton.disabled = currentQuestionIndex === 0;
            if (currentQuestionIndex < shuffledQuestions.length - 1) {
                nextButton.textContent = "Siguiente";
                nextButton.disabled = false;
            } else {
                nextButton.textContent = "Finalizar Prueba";
                nextButton.disabled = false;
            }
        }

        function navigateQuestions(direction) {
            saveCurrentAnswer();
            currentQuestionIndex += direction;

            if (currentQuestionIndex < 0) {
                currentQuestionIndex = 0;
            } else if (currentQuestionIndex >= shuffledQuestions.length) {
                submitQuiz();
                return;
            }

            renderQuestion();
        }
        
        function calculateScore() {
            rawScore = 0;
            incorrectQuestionsData = [];
            correctQuestionsData = [];

            shuffledQuestions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                const questionScore = 1;
                let isQuestionCorrect = false;

                if (question.type === "single-choice") {
                    const correctText = question.answer;
                    if (userAnswer && userAnswer.trim() === correctText.trim()) {
                        rawScore += questionScore;
                        isQuestionCorrect = true;
                    }
                } else if (question.type === "multiple-select") {
                    const correctValues = question.options.filter(o => o.isCorrect).map(o => o.value);
                    const userValues = userAnswer || [];
                    const isFullyCorrect = correctValues.length === userValues.length &&
                                           correctValues.every(val => userValues.includes(val));
                    
                    if (isFullyCorrect) {
                        rawScore += questionScore;
                        isQuestionCorrect = true;
                    }

                } else if (question.type === "multi-direct-answer") {
                    if (userAnswer) {
                        const totalParts = question.parts.length;
                        let correctPartsCount = 0;
                        question.parts.forEach((part, partIndex) => {
                            const userAnswerPart = userAnswer[partIndex];
                            if (isAnswerCorrect(userAnswerPart, part.answer)) {
                                correctPartsCount++;
                            }
                        });
                        rawScore += (correctPartsCount / totalParts) * questionScore;
                        isQuestionCorrect = correctPartsCount === totalParts;
                    }
                }

                const scoreThisQuestion = isQuestionCorrect ? questionScore : 0;
                
                if (scoreThisQuestion > 0) {
                    correctQuestionsData.push({
                        question: question.question.split('<br>')[0],
                        score: scoreThisQuestion
                    });
                } else {
                    incorrectQuestionsData.push({
                        question: question.question.split('<br>')[0],
                        userAnswer: userAnswer,
                        correctAnswer: question.type === "single-choice" ? question.answer : 
                                      (question.type === "multiple-select" ? 
                                      question.options.filter(o => o.isCorrect).map(o => o.text).join(', ') :
                                      question.parts.map(p => p.answer.join(' / ')).join(' | ')),
                    });
                }
            });
            const finalScore = (rawScore / (shuffledQuestions.length)) * FINAL_MAX_SCORE;
            return finalScore.toFixed(2);
        }

        async function submitQuiz() {
            stopTimer();
            saveCurrentAnswer();
            const finalScore = calculateScore();

            if (userIdCard !== UNLIMITED_ACCESS_ID) {
                const isQuizCompletedKey = QUIZ_COMPLETED_PREFIX + userIdCard;
                localStorage.setItem(isQuizCompletedKey, 'true');
            }

            showScreen('results-screen');
            
            const quizResultsData = {
                userName: userName,
                userSurname: userSurname,
                userEmail: userEmail,
                userIdCard: userIdCard,
                module: currentQuizData.name,
                finalScore: finalScore,
                totalQuestions: shuffledQuestions.length,
                correctQuestions: correctQuestionsData.length,
                incorrectQuestions: incorrectQuestionsData.length,
                incorrectAnswers: incorrectQuestionsData.map(q => `Tema: ${q.question}, Respuesta del estudiante: ${JSON.stringify(q.userAnswer)}, Respuesta correcta: ${q.correctAnswer}`).join('; '),
                quizDuration: quizSubmittedByTimeOut ? QUIZ_DURATION_MINUTES + ' minutos' : `${Math.floor((new Date() - quizStartTime) / 1000 / 60)} minutos`,
                timeOut: quizSubmittedByTimeOut ? 'Sí' : 'No'
            };
            
            sendEmailButton.disabled = false;
            sendEmailButton.addEventListener('click', () => sendDeliaEmail(quizResultsData));
        }

        async function sendDeliaEmail(quizResultsData) {
            sendEmailButton.disabled = true;
            statusMessage.textContent = 'Enviando resultados...';
            statusMessage.classList.remove('hidden');

            const requestBody = {
                action: "submitScore",
                email: quizResultsData.userEmail,
                idCard: quizResultsData.userIdCard,
                score: quizResultsData.finalScore,
                module: quizResultsData.module,
                attemptsColumn: currentQuizData.attemptsColumn
            };

            try {
                const response = await fetch(resultsAppScriptUrl, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    redirect: 'follow',
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                if (data.success) {
                    statusMessage.textContent = 'Resultados guardados en la hoja de cálculo.';
                    emailjs.send('default_service', 'template_j60u6b9', {
                        to_name: 'Administración',
                        from_name: 'Step by Step Academy',
                        student_name: `${quizResultsData.userName} ${quizResultsData.userSurname}`,
                        student_email: quizResultsData.userEmail,
                        student_id: quizResultsData.userIdCard,
                        module: quizResultsData.module,
                        score: quizResultsData.finalScore,
                        incorrect_answers: quizResultsData.incorrectAnswers,
                        quiz_duration: quizResultsData.quizDuration,
                        submitted_by_timeout: quizResultsData.timeOut
                    }).then(() => {
                        statusMessage.textContent = 'Resultados enviados a la administración y guardados en la hoja de cálculo.';
                        sendEmailButton.disabled = true;
                        setTimeout(() => showFinalThanksMessage(), 2000);
                    }, (error) => {
                        statusMessage.textContent = `Error al enviar los resultados por correo: ${JSON.stringify(error)}. Sin embargo, los resultados se guardaron en la hoja de cálculo.`;
                    });
                } else {
                    statusMessage.textContent = `Error al guardar los resultados en la hoja de cálculo: ${data.message}`;
                    sendEmailButton.disabled = false;
                }
            } catch (error) {
                statusMessage.textContent = `Error al comunicarse con Apps Script: ${error}`;
                sendEmailButton.disabled = false;
            }
        }

        function showFinalThanksMessage() {
            quizAppContainer.classList.add('hidden');
            finalThanksMessage.classList.remove('hidden');
            setTimeout(() => {
                finalThanksMessage.classList.add('show');
            }, 50);
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            quizAppContainer = document.getElementById('quiz-app');
            mainHeader = document.getElementById('main-header');
            loginScreen = document.getElementById('login-screen');
            mainScreen = document.getElementById('main-screen');
            instructionsScreen = document.getElementById('instructions-screen');
            quizScreen = document.getElementById('quiz-screen');
            resultsScreen = document.getElementById('results-screen');
            startAppButton = document.getElementById('start-app-button');
            startModuleButton = document.getElementById('start-module-button');
            startFirstQuestionButton = document.getElementById('start-first-question-button');
            userNameInput = document.getElementById('user-name');
            userSurnameInput = document.getElementById('user-surname');
            userEmailInput = document.getElementById('user-email');
            userIdCardInput = document.getElementById('user-id-card');
            moduleSelect = document.getElementById('module-select');
            moduleInfo = document.getElementById('module-info');
            moduleDescription = document.getElementById('module-description');
            moduleDuration = document.getElementById('module-duration');
            attemptsDisplay = document.getElementById('attempts-display');
            remainingAttemptsSpan = document.getElementById('remaining-attempts');
            questionCounter = document.getElementById('question-counter');
            progressBar = document.getElementById('progress-bar');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            nextButton = document.getElementById('next-button');
            prevButton = document.getElementById('prev-button');
            sendEmailButton = document.getElementById('send-delia-email-button');
            statusMessage = document.getElementById('email-status-message');
            finalThanksMessage = document.getElementById('final-thanks-message');
            timerDisplay = document.getElementById('timer-display');
            
            showScreen('login-screen');

            userNameInput.addEventListener('input', checkLoginInputsAndEnableButton);
            userSurnameInput.addEventListener('input', checkLoginInputsAndEnableButton);
            userEmailInput.addEventListener('input', checkLoginInputsAndEnableButton);
            userIdCardInput.addEventListener('input', checkLoginInputsAndEnableButton);

            startAppButton.addEventListener('click', startApp);
            moduleSelect.addEventListener('change', loadModule);
            startModuleButton.addEventListener('click', startModule);
            startFirstQuestionButton.addEventListener('click', () => {
                showScreen('quiz-screen');
                startTimer();
                renderQuestion();
            });

            prevButton.addEventListener('click', () => navigateQuestions(-1));
            nextButton.addEventListener('click', () => navigateQuestions(1));
        });
    </script>
</body>
</html>
